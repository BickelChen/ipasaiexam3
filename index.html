<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iPAS AI 應用規劃師刷題系統 – 50 題通用模式</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* ======= 基本樣式，沿用舊版 ======= */
        * {margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Microsoft JhengHei',Arial,sans-serif;line-height:1.6;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;}
        .container{max-width:1000px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,0.1);overflow:hidden;}
        .header{background:linear-gradient(45deg,#2196F3,#21CBF3);color:#fff;padding:30px;text-align:center;}
        .header h1{font-size:2.2rem;margin-bottom:8px;text-shadow:2px 2px 4px rgba(0,0,0,0.3);}        
        .setup-form{padding:40px;background:#f8f9fa;text-align:center;}
        .start-btn{background:linear-gradient(45deg,#FF6B6B,#FF8E53);color:#fff;border:none;padding:15px 60px;font-size:1.3rem;border-radius:30px;cursor:pointer;margin-top:10px;transition:.3s;font-weight:bold;}
        .start-btn:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(255,107,107,.3);}        
        .quiz-container{display:none;padding:40px;}
        .question-header{background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:30px;display:flex;justify-content:space-between;align-items:center;}
        .question-number{font-size:1.2rem;font-weight:bold;color:#2196F3;}
        .progress-bar{flex:1;margin:0 20px;height:8px;background:#ddd;border-radius:4px;overflow:hidden;}
        .progress-fill{height:100%;background:linear-gradient(45deg,#2196F3,#21CBF3);transition:width .3s;}
        .question-content{background:#fff;border:2px solid #f0f0f0;border-radius:10px;padding:30px;margin-bottom:30px;}
        .question-text{font-size:1.15rem;margin-bottom:25px;color:#333;line-height:1.8;}
        .options{display:grid;gap:15px;}
        .option{padding:15px 20px;border:2px solid #e0e0e0;border-radius:10px;cursor:pointer;transition:.3s;background:#fff;}
        .option:hover{border-color:#2196F3;background:#f0f8ff;}
        .option.selected{border-color:#2196F3;background:#e3f2fd;}
        .quiz-navigation{display:flex;justify-content:space-between;align-items:center;margin-top:30px;flex-wrap:wrap;gap:10px;}
        .nav-btn{padding:12px 30px;border:none;border-radius:25px;font-size:1rem;cursor:pointer;transition:.3s;font-weight:bold;}
        .prev-btn{background:#6c757d;color:#fff;}
        .next-btn{background:#2196F3;color:#fff;}
        .submit-btn{background:#28a745;color:#fff;}
        .nav-btn:hover{transform:translateY(-2px);}        
        .nav-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
        .results-container{display:none;padding:40px;}
        .score-display{text-align:center;background:linear-gradient(45deg,#28a745,#20c997);color:#fff;padding:40px;border-radius:15px;margin-bottom:30px;}
        .score-number{font-size:4rem;font-weight:bold;margin-bottom:10px;}
        .score-text{font-size:1.5rem;}
        .question-review{margin-bottom:25px;border:2px solid #f0f0f0;border-radius:10px;overflow:hidden;}
        .review-header{background:#f8f9fa;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;}
        .review-content{padding:20px;}
        .correct{border-left:5px solid #28a745;}
        .incorrect{border-left:5px solid #dc3545;}
        .answer-status{font-weight:bold;padding:5px 15px;border-radius:15px;font-size:.9rem;}
        .answer-status.correct{background:#d4edda;color:#155724;}
        .answer-status.incorrect{background:#f8d7da;color:#721c24;}
        .explanation{background:#fff3cd;border:1px solid #ffeaa7;border-radius:8px;padding:15px;margin-top:15px;}
        .restart-btn{background:#007bff;color:#fff;border:none;padding:15px 40px;font-size:1.1rem;border-radius:25px;cursor:pointer;margin-top:30px;transition:.3s;}
        .restart-btn:hover{background:#0056b3;transform:translateY(-2px);}        
        .loading{text-align:center;padding:40px;font-size:1.2rem;color:#666;}
        .error{background:#f8d7da;color:#721c24;padding:20px;border-radius:8px;margin:20px;}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 iPAS AI 應用規劃師刷題系統 – 50 題通用模式</h1>
            <p>取消分科目 / 單元，隨機抽取 50 題</p>
        </div>

        <!-- === 設定畫面 === -->
        <div id="setupForm" class="setup-form">
            <p>點擊下方按鈕立即開始（題目數量固定 50 題）。</p>
            <button class="start-btn" onclick="startQuiz()">開始測驗</button>
        </div>

        <!-- === 測驗畫面 === -->
        <div id="quizContainer" class="quiz-container">
            <div class="question-header">
                <div class="question-number" id="questionNumber">題目 1 / 50</div>
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            </div>
            <div class="question-content">
                <div class="question-text" id="questionText"></div>
                <div class="options" id="options"></div>
            </div>
            <div class="quiz-navigation">
                <button class="nav-btn prev-btn" onclick="previousQuestion()" id="prevBtn" disabled>上一題</button>
                <button class="nav-btn next-btn" onclick="nextQuestion()" id="nextBtn">下一題</button>
                <button class="nav-btn submit-btn" onclick="submitQuiz()" id="submitBtn" style="display:none;">提交答案</button>
            </div>
        </div>

        <!-- === 結果畫面 === -->
        <div id="resultsContainer" class="results-container">
            <div class="score-display">
                <div class="score-number" id="scoreNumber">0</div><div class="score-text">分</div>
                <p>答對 <span id="correctCount">0</span> 題，共 <span id="totalCount">50</span> 題</p>
            </div>
            <div id="reviewList"></div>
            <button class="restart-btn" onclick="restartQuiz()">重新測驗</button>
        </div>
        <div id="loading" class="loading" style="display:none;">載入題庫中...</div>
    </div>

<script>
// ================= 全域變數 =================
let questionsData=[];              // 原始題庫
let currentQuestions=[];           // 本次抽取的 50 題
let currentQuestionIndex=0;
let userAnswers=[];
const QUESTION_QUANTITY=50;

// ================= 載入完成 =================
document.addEventListener('DOMContentLoaded',()=>{
  loadQuestions();
});

// ================= 載入題庫 =================
async function loadQuestions(){
  document.getElementById('loading').style.display='block';
  try{
    const response=await fetch('question.csv');
    if(!response.ok) throw new Error(`HTTP error ${response.status}`);
    const csv=await response.text();
    Papa.parse(csv,{header:true,skipEmptyLines:true,complete:results=>{questionsData=results.data;document.getElementById('loading').style.display='none';},error:err=>{throw err}});
  }catch(e){
    console.error('載入 CSV 失敗，使用範例資料',e);
    loadSampleData();
  }
}

function loadSampleData(){
  questionsData=[{id:'SAMPLE-001',question:'Sample Q1',optionA:'A',optionB:'B',optionC:'C',optionD:'D',answer:'A',explanation:'Just a sample.'}];
  document.getElementById('loading').style.display='none';
}

// ================= 開始測驗 =================
function startQuiz(){
  if(questionsData.length<QUESTION_QUANTITY){
    alert('題庫不足 50 題，請先補充題庫。');return;
  }
  currentQuestions=shuffleArray([...questionsData]).slice(0,QUESTION_QUANTITY);
  userAnswers=new Array(QUESTION_QUANTITY).fill(null);
  currentQuestionIndex=0;

  document.getElementById('setupForm').style.display='none';
  document.getElementById('quizContainer').style.display='block';
  showQuestion();
}

// ================= 顯示題目 =================
function showQuestion(){
  const q=currentQuestions[currentQuestionIndex];
  const num=currentQuestionIndex+1;
  document.getElementById('questionNumber').textContent=`題目 ${num} / ${QUESTION_QUANTITY}`;
  document.getElementById('progressFill').style.width=`${(num/QUESTION_QUANTITY)*100}%`;
  document.getElementById('questionText').textContent=q.question;

  const options=document.getElementById('options');
  options.innerHTML='';
  ['A','B','C','D'].forEach(opt=>{
    const div=document.createElement('div');
    div.className='option';
    div.innerHTML=`<strong>${opt}.</strong> ${q[`option${opt}`]}`;
    div.addEventListener('click',()=>selectOption(opt,div));
    if(userAnswers[currentQuestionIndex]===opt) div.classList.add('selected');
    options.appendChild(div);
  });

  document.getElementById('prevBtn').disabled=currentQuestionIndex===0;
  document.getElementById('nextBtn').style.display=currentQuestionIndex===QUESTION_QUANTITY-1?'none':'block';
  document.getElementById('submitBtn').style.display=currentQuestionIndex===QUESTION_QUANTITY-1?'block':'none';
}

function selectOption(opt,el){
  document.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
  el.classList.add('selected');
  userAnswers[currentQuestionIndex]=opt;
}

function previousQuestion(){if(currentQuestionIndex>0){currentQuestionIndex--;showQuestion();}}
function nextQuestion(){if(currentQuestionIndex<QUESTION_QUANTITY-1){currentQuestionIndex++;showQuestion();}}

// ================= 提交測驗 =================
function submitQuiz(){
  const unanswered=userAnswers.map((a,i)=>a===null?i+1:null).filter(x=>x);
  if(unanswered.length>0&&!confirm(`還有 ${unanswered.length} 題未作答（第 ${unanswered.join(', ')} 題），確定要提交嗎？`))return;
  const correctCount=userAnswers.reduce((n,ans,i)=>n+(ans===currentQuestions[i].answer),0);
  const score=Math.round((correctCount/QUESTION_QUANTITY)*100);
  showResults(score,correctCount);
}

function showResults(score,correct){
  document.getElementById('quizContainer').style.display='none';
  document.getElementById('resultsContainer').style.display='block';
  document.getElementById('scoreNumber').textContent=score;
  document.getElementById('correctCount').textContent=correct;
  document.getElementById('totalCount').textContent=QUESTION_QUANTITY;

  const review=document.getElementById('reviewList');
  review.innerHTML='';
  currentQuestions.forEach((q,i)=>{
    const isCorrect=userAnswers[i]===q.answer;
    const div=document.createElement('div');
    div.className=`question-review ${isCorrect?'correct':'incorrect'}`;
    div.innerHTML=`<div class="review-header"><span>第 ${i+1} 題</span><span class="answer-status ${isCorrect?'correct':'incorrect'}">${isCorrect?'✓ 答對':'✗ 答錯'}</span></div><div class="review-content"><p><strong>題目：</strong>${q.question}</p><p><strong>您的答案：</strong>${userAnswers[i]?userAnswers[i]+'. '+q['option'+userAnswers[i]]:'未作答'}</p><p><strong>正確答案：</strong>${q.answer}. ${q['option'+q.answer]}</p>${q.explanation?`<div class="explanation"><strong>解析：</strong>${q.explanation}</div>`:''}</div>`;
    review.appendChild(div);
  });
}

// ================= 重新測驗 =================
function restartQuiz(){
  document.getElementById('resultsContainer').style.display='none';
  document.getElementById('setupForm').style.display='block';
}

// ================= 工具 =================
function shuffleArray(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
</script>
</body>
</html>
